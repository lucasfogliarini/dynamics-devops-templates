parameters:
- name: SolutionName
  type: string
- name: Branch
  type: string
- name: DevServiceConnectionName
  type: string
- name: DevServiceConnectionURL
  type: string

steps:
# Init git
- script: |
   git config user.email "$(Build.RequestedForEmail)"
   git config user.name "$(Build.RequestedFor)"       
   git checkout origin/${{parameters.Branch}} --track
  workingDirectory: $(Build.SourcesDirectory)\$(Build.Repository.Name)
  displayName: 'Initialize Git'

- task: PowerPlatformToolInstaller@2
  inputs:
    DefaultVersion: true

# Use set-connection-variables task to get values from AzDO Service Connection to be used in scripts that don't use tasks
- task: PowerPlatformSetConnectionVariables@2
  displayName: 'Set Connection Variables'
  name: connectionVariables
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: ${{parameters.DevServiceConnectionName}}
    Environment: ${{parameters.DevServiceConnectionURL}}

- template: set-spn-token.yml
  parameters:
    dynamicsUrl: ${{parameters.DevServiceConnectionURL}}
    tenantId: $(connectionVariables.BuildTools.TenantId)
    clientId: $(connectionVariables.BuildTools.ApplicationId)
    clientSecret: $(connectionVariables.BuildTools.ClientSecret)
  
# Upload JavaScript
- powershell: |
    # load PowerShell files into memory
    . "$(Build.SourcesDirectory)\$(Build.Repository.Name)\upload-webresource.ps1"
    try {
        Upload-Javascript "$(DevServiceConnectionURL)" "$env:MAPPED_SPN_Token" "$(SolutionName)" "$(Build.SourcesDirectory)\$(Build.Repository.Name)\src\WebResources"
    } catch {
        Write-Host "##vso[task.logissue type=warning]Error occurred while upload webresource solution."
        Write-Host $_
        exit 1;
    }
    displayName: 'Upload Web Resources Javascript'
    env:
     MAPPED_SPN_Token: $(SpnToken)